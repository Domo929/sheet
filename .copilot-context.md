# Copilot Session Context - D&D 5e Character Sheet TUI

**Last Updated:** 2026-01-18
**Current Branch:** `feature/inventory-system` (PR #24)
**Repository:** github.com:Domo929/sheet

## Project Overview

A D&D 5e (2024 rules) character sheet TUI application built in Go using Bubble Tea. The application allows creating, managing, and playing D&D characters with a terminal-based interface.

## Tech Stack

- **Language:** Go
- **TUI Framework:** Bubble Tea (github.com/charmbracelet/bubbletea)
- **Styling:** Lipgloss (github.com/charmbracelet/lipgloss)
- **Storage:** JSON files in `~/.config/sheet/characters/`

## Project Structure

```
sheet/
├── cmd/sheet/          # Main entry point
├── data/               # JSON data files (equipment, races, classes, spells, etc.)
├── internal/
│   ├── data/           # Data loading (loader.go, equipment.go)
│   ├── models/         # Domain models (character.go, inventory.go, etc.)
│   ├── storage/        # Character persistence
│   └── ui/
│       ├── views/      # Main views (main_sheet.go, inventory.go, character_selection.go)
│       ├── components/ # Reusable UI components
│       └── model.go    # Main UI router
├── DESIGN.md           # Original design document
└── IMPLEMENTATION.md   # Implementation phases
```

## Completed Phases

### Phase 1-4: Core Character Creation ✅
- Race, class, background selection
- Ability score assignment (manual, point buy, standard array)
- Skill and proficiency selection
- Character saving/loading

### Phase 5: Character Sheet Display ✅
- Main sheet with tabbed navigation
- Abilities & Saving Throws (combined horizontal layout)
- Skills with proficiency/expertise indicators
- Combat stats (HP, AC, Speed, Hit Dice)
- Actions tab with weapon attacks, unarmed strikes, and standard actions (Dash, Dodge, etc.)
- Spells, Character Info, Equipment buttons

### Phase 5a: UI Refinements ✅
- Header with proficiency/expertise legend
- Dynamic column widths
- Passive skills (Perception, Investigation, Insight)
- Skill modifiers aligned properly

### Phase 6: Combat Mechanics ✅
- HP tracking with damage/heal/temp HP
- Health bar with temp HP visualization (blue/dark green)
- Death saves
- Condition tracking
- Weapon attacks with proper modifiers and properties

### Phase 7: Rest Mechanics ✅ (PR #23 merged)
- Short rest with hit dice spending
- Long rest for full recovery
- Result screen showing healing breakdown
- CON modifier displayed in short rest

### Phase 8: Inventory System ✅ (PR #24 - in progress)
- Three-panel layout: Equipment | Items | Currency
- Equipment slots (Main Hand, Off Hand, Head, Body, Cloak, Gloves, Boots, Amulet, Rings)
- Item list with scrolling and type indicators
- Currency tracking with color-coded display

**Recent additions to Phase 8:**
- `a` key: Add items (searches equipment database) or add currency
- `s` key: Spend currency
- `n` key: Adjust item quantity
- `x` key: Delete item (with confirmation)
- `e` key: Equip/unequip items
- `q` key: Quit with confirmation
- `Ctrl+C`: Immediate quit
- Container/pack viewing (Enter on pack to see contents)
- Unequip from Equipment panel
- **Smart currency spending from "Total"** - auto-converts currency types
- Status message on separate line from help text

## Key Files Modified Recently

### `internal/ui/views/inventory.go`
- Full inventory view implementation
- Key handlers for all inventory actions
- Add item search with equipment database lookup
- Currency handling with add/spend modes
- Smart spending from total (SpendFromTotal)

### `internal/models/inventory.go`
- `Currency` struct with all denomination methods
- `SpendFromTotal(goldAmount int)` - auto-converts and redistributes currency
- `Item` struct with `Contents []Item` for containers
- Equipment slots and attunement tracking

### `internal/ui/views/main_sheet.go`
- Rest mechanics (RestMode enum, performShortRest, performLongRest)
- Weapon attacks showing only equipped weapons
- Quit confirmation flow
- Actions tab with standard D&D actions

### `internal/ui/views/character_selection.go`
- Quit confirmation added

## Test Characters

- **Holly** - Has basic equipment, used for testing
- **Gan** - Has Quarterstaff (Main Hand) and Light Crossbow (Off Hand), used for weapon testing

## Current State

PR #24 is ready for review/merge. All tests pass. The inventory system is functional with:
- Full CRUD for items
- Currency management including smart spending
- Equipment slot management
- Container viewing

## Remaining Work / Future Phases

### Phase 9: Spellcasting (not started)
- Spell slot tracking
- Spell list with prepared spells
- Spell details and casting

### Phase 10: Leveling (not started)
- Level up flow
- Ability score improvements
- New feature selection

### Other TODOs
- Dice rolling system (currently uses expected values)
- More item properties (attunement, charges for magic items)
- Import/export characters
- Multiple ring selection in equipment panel
- Pack contents editing from Equipment panel (partially done)

## Commands

```bash
# Build
go build ./...

# Run
go run ./cmd/sheet

# Test
go test ./...

# Test specific package
go test ./internal/ui/views/... -v
```

## Key Bindings Summary

### Main Sheet
- `Tab/Shift+Tab`: Navigate sections
- `↑/↓`: Navigate within section
- `r`: Open rest menu
- `i`: Open inventory
- `q`: Quit (with confirmation)
- `Ctrl+C`: Force quit

### Inventory
- `Tab`: Switch panels (Equipment → Items → Currency)
- `↑/↓`: Navigate items/slots
- `a/+`: Add item or currency
- `s/-`: Spend currency
- `n/#`: Adjust quantity
- `x/Delete`: Delete item
- `e`: Equip/unequip
- `Enter`: Open container/pack
- `Esc`: Back/close
- `q`: Quit (confirmation)
- `Ctrl+C`: Force quit

### Currency Panel
- Navigate to "Total" (below PP) for smart spending
- `a`: Add currency
- `s`: Spend currency (auto-converts when on Total)
